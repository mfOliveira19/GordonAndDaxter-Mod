(in-package goal)
(require "engine/game/game-h.gc")
(define *grenade-explosion-position* (new 'global 'vector))
(defconstant grenade-rotate-speed 600.0)
(defconstant grenade-damage 120)

(defpartgroup group-smg-grenade-explosion
  :id 710
  :flags (use-local-clock)
  :bounds (static-bspherem 0 0 0 16)
  :parts
  ((sp-item 3000 :period (seconds 4) :length (seconds 0.1))
   (sp-item 3001 :fade-after (meters 60) :period (seconds 4) :length (seconds 0.05))
   (sp-item 3002 :period (seconds 4) :length (seconds 0.05) :offset 15)
   (sp-item 3003 :period (seconds 4) :length (seconds 0.05))
   (sp-item 3004 :fade-after (meters 80) :falloff-to (meters 80) :period (seconds 4) :length (seconds 0.1) :binding 3005)
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))
   (sp-item 3005 :flags (start-dead))))

(defpart 3000
  :init-specs
  ((:texture (bigpuff effects))
   (:num 1.5)
   (:y (meters 0.5) (meters 0.5))
   (:scale-x (meters 2.5) (meters 1.5))
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y :copy scale-x)
   (:r 70.0)
   (:g 70.0)
   (:b 70.0 16.0)
   (:a 96.0)
   (:vel-y (meters 0.006666667) (meters 0.033333335))
   (:scalevel-x (meters 0.006))
   (:rotvel-z (degrees -0.2) (degrees 0.4))
   (:scalevel-y :copy scalevel-x)
   (:accel-y (meters 0.00005))
   (:friction 0.92)
   (:timer (seconds 3))
   (:flags (bit2 bit12 bit14))
   (:next-time (seconds 0.1) (seconds 0.997))
   (:next-launcher 3006)
   (:conerot-x (degrees 70) (degrees 20))
   (:conerot-y (degrees 0) (degrees 360))
   (:conerot-radius (meters 2))))

(defpart 3006
  :init-specs ((:scalevel-x (meters 0)) (:scalevel-y :copy scalevel-x) (:fade-a -0.32)))

(defpart 3001
  :init-specs
  ((:texture (flare effects))
   (:num 6.0)
   (:y (meters 0.75))
   (:scale-x (meters 8) (meters 8))
   (:rot-x 4)
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y (meters 1.2) (meters 3))
   (:r 192.0)
   (:g 192.0)
   (:b 64.0 128.0)
   (:a 0.0)
   (:scalevel-x (meters 0.009765625))
   (:rotvel-z (degrees -0.15) (degrees 0.3))
   (:scalevel-y (meters 0.009765625))
   (:fade-a 2.1333334)
   (:timer (seconds 0.1))
   (:flags (bit2 bit3 bit14))
   (:next-time (seconds 0.05))
   (:next-launcher 3007)
   (:rotate-y (degrees 0))))

(defpart 3007
  :init-specs ((:fade-a -1.3333334)))

(defpart 3002
  :init-specs
  ((:texture (starflash effects))
   (:num 1.0)
   (:y (meters 1))
   (:scale-x (meters 24) (meters 16))
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y :copy scale-x)
   (:r 196.0)
   (:g 196.0)
   (:b 196.0)
   (:a 64.0)
   (:timer (seconds 0.017))
   (:flags (bit2 bit3 bit14))))

(defpart 3003
  :init-specs
  ((:texture (starflash effects))
   (:num 1.0)
   (:y (meters 1))
   (:scale-x (meters 24) (meters 16))
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y :copy scale-x)
   (:r 196.0)
   (:g 32.0)
   (:b 32.0)
   (:a 64.0)
   (:timer (seconds 0.017))
   (:flags (bit2 bit3 bit14))))

(defpart 3004
  :init-specs
  ((:texture (hotdot effects))
   (:num 5.0 10.0)
   (:x (meters -0.5) (meters 1))
   (:y (meters 0.25) (meters 1.5))
   (:z (meters -0.5) (meters 1))
   (:scale-x (meters 0.5))
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y :copy scale-x)
   (:r 255.0)
   (:g 127.0 1 127.0)
   (:b 0.0)
   (:a 127.0)
   (:vel-y (meters 0.06666667) (meters 0.06666667))
   (:fade-g -4.266667)
   (:fade-b -2.8444445)
   (:accel-y (meters -0.004))
   (:friction 0.97)
   (:timer (seconds 0.3))
   (:flags (bit2 bit3 bit14))
   (:next-time (seconds 0.017) (seconds 0.127))
   (:next-launcher 3008)
   (:conerot-x (degrees 40) (degrees 30))
   (:conerot-y (degrees 0) (degrees 360))))

(defpart 3008
  :init-specs
  ((:scalevel-x (meters -0.0033333334))
   (:scalevel-y :copy scalevel-x)
   (:fade-r -4.266667)
   (:fade-g 0.7111111)
   (:fade-b 1.4222223)
   (:fade-a -2.8444445)))

(defpart 3005
  :init-specs
  ((:texture (bigpuff effects))
   (:num 2.0)
   (:x (meters -0.25) (meters 0.5))
   (:y (meters -0.25) (meters 0.5))
   (:z (meters -0.25) (meters 0.5))
   (:scale-x (meters 0.5) (meters 0.5))
   (:rot-z (degrees 0) (degrees 360))
   (:scale-y :copy scale-x)
   (:r 70.0)
   (:g 70.0)
   (:b 70.0 16.0)
   (:a 20.0 8.0)
   (:scalevel-x (meters 0.0033333334))
   (:rotvel-z (degrees -0.3) (degrees 0.6))
   (:scalevel-y :copy scalevel-x)
   (:fade-a -0.11666667)
   (:timer (seconds 1))
   (:flags (bit2 bit12 bit14))))

(deftype smg-grenade-init-data (structure)
  ((pos          vector)
   (vel          vector)
   (rotate       float)
   (blast-radius float)))

(deftype smg-grenade (process-drawable)
  ((root         collide-shape-moving :override)
   (tumble-quat  quaternion :inline)
   (blast-radius float)
   (water-height float)
   (sfx          uint32)
   (part2        sparticle-launch-control)
   (ground-time  time-frame))
  (:states
   smg-grenade-explode
   smg-grenade-idle
   smg-grenade-in-water))


(defmethod relocate ((this smg-grenade) (offset int))
  (if (nonzero? (-> this part2)) (&+! (-> this part2) offset))
  (the-as smg-grenade ((method-of-type process-drawable relocate) this offset)))

(defmethod deactivate ((this smg-grenade))
  (if (nonzero? (-> this part2)) (kill-and-free-particles (-> this part2)))
  ((method-of-type process-drawable deactivate) this)
  (none))
#|
(def-art-elt smg-grenade-ag smg-grenade-lod0-jg 0)
(def-art-elt smg-grenade-ag smg-grenade-lod0-mg 1)
(def-art-elt smg-grenade-ag smg-grenade-idle-ja 2)|#
#|
(defskelgroup *smg-grenade-sg* smg-grenade smg-grenade-lod0-jg smg-grenade-idle-ja
              ((smg-grenade-lod0-mg (meters 9999999)))
              :bounds (static-spherem 0 0 0 5))|#
(def-actor smg-grenade :bounds (0 0 0 5))

(defstate smg-grenade-idle (smg-grenade)
  :event
    (behavior ((proc process) (argc int) (message symbol) (block event-message-block))
      (case message
        (('attack) (go smg-grenade-explode))))
  :enter
    (behavior ()
      (set-time! (-> self state-time))
      (set! (-> self sfx) (the-as uint 0))
      0)
  :trans
    (behavior ()
      (if (< (-> self root trans y) (-> self water-height)) (go smg-grenade-in-water)))
  :code
    (behavior ()
      (loop 
      (quaternion-axis-angle! (-> self tumble-quat)
                              1.0 0.0 0.0
                              (* grenade-rotate-speed (-> *display* time-adjust-ratio)))
      (quaternion*! (-> self root quat) (-> self root quat) (-> self tumble-quat))
      (suspend)
      (set-vector! (-> self root scale) 0.6 0.6 0.6 1.0))

      (restore-collide-with-as (-> self root))
      (set-vector! (-> self root scale) 0.6 0.6 0.6 1.0)
      (while (not (logtest? (-> self root status) (cshape-moving-flags onsurf)))
        (when (nonzero? (-> self sfx))
          (let ((gp-1 (the-as sound-rpc-set-param (get-sound-buffer-entry))))
            (set! (-> gp-1 command) (sound-command set-param))
            (set! (-> gp-1 id) (the-as sound-id (-> self sfx)))
            (let ((a1-3 (-> self root trans)))
              (let ((s5-1 self))
                (when (= a1-3 #t)
                  (if (and s5-1 (type-type? (-> s5-1 type) process-drawable) (nonzero? (-> s5-1 root)))
                    (set! a1-3 (-> s5-1 root trans))
                    (set! a1-3 (the-as vector #f)))))
              (sound-trans-convert (-> gp-1 parms trans) a1-3))
            (set! (-> gp-1 parms mask) (sound-mask trans))
            (-> gp-1 id)))
        (suspend))
      (quaternion-set! (-> self root quat) 0.0 0.0 0.0 1.0)
      (update-transforms! (-> self root))
      (when (nonzero? (-> self sfx))
        (sound-stop (the-as sound-id (-> self sfx)))
        (set! (-> self sfx) (the-as uint 0))
        0)
      (set-time! (-> self ground-time))
      (go smg-grenade-explode))
  :post
    (behavior ()
      (vector-v++! (-> self root transv) (compute-acc-due-to-gravity (-> self root) (new-stack-vector0) 1.0))
      (set! (-> self root root-prim prim-core offense) (collide-offense touch))
      (fill-cache-integrate-and-collide! (-> self root) (-> self root transv) (-> self root root-prim collide-with))
      (set! (-> self root root-prim prim-core offense) (collide-offense indestructible))
      (ja-post)
      ))


(defstate smg-grenade-in-water (smg-grenade)
  :code
    (behavior ()
      (when (nonzero? (-> self sfx))
        (sound-stop (the-as sound-id (-> self sfx)))
        (set! (-> self sfx) (the-as uint 0))
        0)
      (let ((a1-0 (new-stack-vector0)))
        (set! (-> a1-0 x) (-> self root trans x))
        (set! (-> a1-0 y) (-> self water-height))
        (set! (-> a1-0 z) (-> self root trans z))
        (set! (-> a1-0 w) 1.0)
        (splash-spawn (the-as basic 1.0) (the-as basic a1-0) 1))
      (label cfg-3)
      (vector-v++! (-> self root transv) (compute-acc-due-to-gravity (-> self root) (new-stack-vector0) 1.0))
      (vector-float*! (-> self root transv) (-> self root transv) 0.5)
      (update-transforms! (-> self root))
      (fill-cache-integrate-and-collide! (-> self root) (-> self root transv) (-> self root root-prim collide-with))
      (seek! (-> self root scale x) 0.0 (/ (-> *display* time-adjust-ratio) 100))
      (seek! (-> self root scale y) 0.0 (/ (-> *display* time-adjust-ratio) 100))
      (seek! (-> self root scale z) 0.0 (/ (-> *display* time-adjust-ratio) 100))
      (when (< 0.05 (-> self root scale x))
        (suspend)
        (goto cfg-3))
      )
  :post ja-post
  )

(defstate smg-grenade-explode (smg-grenade)
  :enter 
  (behavior ()
    (set-vector! *grenade-explosion-position* (-> self root trans x) (-> self root trans y) (-> self root trans z) (-> self root trans w))
  )
  :event
    (behavior ((proc process) (argc int) (message symbol) (block event-message-block))
      (case message
        (('touched)
         (let* ((s4-0 proc)
                (v1-2 (if (and (nonzero? s4-0) (type-type? (-> s4-0 type) process-drawable)) s4-0)))
           (when v1-2
             (let* ((v1-3 (-> (the-as smg-grenade v1-2) root))
                    (a1-2 (-> self root root-prim prim-core))
                    (v1-5 (-> v1-3 root-prim prim-core))
                    (a2-1 (new 'stack-no-clear 'vector))
                    (t2-0 (new 'stack-no-clear 'collide-tri-result)))
               0.0
               (vector-! a2-1 (the-as vector v1-5) (the-as vector a1-2))
               (when (< (fill-and-probe-using-line-sphere *collide-cache*
                                                          (the-as vector a1-2)
                                                          a2-1
                                                          40.96
                                                          (collide-kind background)
                                                          self
                                                          t2-0
                                                          (new 'static 'pat-surface :noentity #x1))
                        0.0)               
                 (cond
                   ((= (-> proc type) target) (send-event proc 'attack-hl (-> block param 0) (static-attack-info ((mode 'explode)))))
                   (else
                    (let ((a1-4 (new 'stack-no-clear 'event-message-block)))
                      (set! (-> a1-4 from) self)
                      (set! (-> a1-4 num-params) 4)
                      (set! (-> a1-4 message) 'attack-hl)
                      (set! (-> a1-4 param 0) (-> block param 0))
                      (set! (-> a1-4 param 1) (the-as uint 'explode))
                      (let ((v1-18 (+ *global-attack-id* 1))) (set! *global-attack-id* v1-18) (set! (-> a1-4 param 2) (the-as uint v1-18)))
                      (set! (-> a1-4 param 3) (the-as uint 0))
                      (set! (-> a1-4 param 4) (the-as int8 grenade-damage)) ;; This will be the damage
                      (send-event-function proc a1-4))))
                      )))))))
  :code
    (behavior ()
        (let ((idx (rand-vu-int-range 0 2)))
        (case idx
            ((0) (sound-play "explosion1"))
            ((1) (sound-play "explosion2"))
            ((2) (sound-play "explosion3"))))
      (ja-channel-set! 0)
      (let ((v1-11 (-> self root root-prim)))
        (set! (-> v1-11 local-sphere w) (-> self blast-radius))
        (set! (-> v1-11 prim-core world-sphere w) (-> self blast-radius))
        (set! (-> v1-11 collide-with) 
            (collide-kind
                water
                background
                crate
                cak-1
                cak-2 
                cak-3 
                enemy
                target
                wall-object
                ground-object
                mother-spider
                cak-14
                blue-eco-suck
                unknown-16
                unknown-17
                unknown-18
                unknown-19
                unknown-20
                unknown-21
                unknown-22
                unknown-23
                unknown-24
                unknown-25
                unknown-26
                unknown-27
                unknown-28
                unknown-29
                unknown-30
                unknown-31
                unknown-32
                unknown-33
                unknown-34
                unknown-35
                unknown-36
                unknown-37
                unknown-38
                unknown-39
                unknown-40
                unknown-41
                unknown-42
                unknown-43
                unknown-44
                unknown-45
                unknown-46
                unknown-47
                unknown-48
                unknown-49
                unknown-50
                unknown-51
                unknown-52
                unknown-53
                unknown-54
                unknown-55
                unknown-56
                unknown-57
                unknown-58
                unknown-59
                unknown-60
                unknown-61
                unknown-62
                unknown-63
            )
        )
        (set! (-> v1-11 prim-core collide-as) (collide-kind enemy))
        (set! (-> v1-11 prim-core action) (collide-action attackable)))
      (update-transforms! (-> self root))
      (let ((a1-3 (new 'stack-no-clear 'overlaps-others-params)))
        (set! (-> a1-3 options) (the-as uint 0))
        (set! (-> a1-3 tlist) *touching-list*)
        (find-overlapping-shapes (-> self root) a1-3))
      (suspend)
      (clear-collide-with-as (-> self root))
      (suspend-for (seconds 1.0)
        (spawn (-> self part2) (-> self root trans)))
        ((method-of-type process-drawable deactivate) self)
      (deactivate self))
  :post ja-post
  )

(defun smg-grenade-collision-reaction ((arg0 collide-shape-moving) (arg1 collide-shape-intersect) (arg2 vector) (arg3 vector))
  (let ((owner (-> arg0 process)))
    (when (and owner (type-type? (-> owner type) smg-grenade))
      (send-event owner 'attack)))
  (let ((flags (logior 7)))
    (logior! (-> arg0 status) flags)
    (the-as cshape-moving-flags flags)))

(defbehavior smg-grenade-init-by-other smg-grenade ((arg0 smg-grenade-init-data) (arg1 entity-actor))
  (logior! (-> self mask) (process-mask projectile))
  (logclear! (-> self mask) (process-mask actor-pause))
  (set! (-> self entity) arg1)
  (let ((s5-0 (new 'process 'collide-shape-moving self (collide-list-enum hit-by-player))))
    (set! (-> s5-0 dynam) (copy *standard-dynamics* 'process))
    (set! (-> s5-0 reaction) smg-grenade-collision-reaction)
    (set! (-> s5-0 no-reaction) (the-as (function collide-shape-moving collide-shape-intersect vector vector none) nothing))
    (let ((s4-0 (new 'process 'collide-shape-prim-sphere s5-0 (the-as uint 0))))
      (set! (-> s4-0 prim-core collide-as) (collide-kind projectile))
      (set! (-> s4-0 collide-with) 
        (collide-kind
         background
          cak-1
          cak-2 
          cak-3 
          enemy 
          wall-object
          ground-object
          mother-spider
          cak-14
          blue-eco-suck
         )
      )
      (set! (-> s4-0 prim-core action) (collide-action solid))
      (set! (-> s4-0 prim-core offense) (collide-offense touch))
      (set! (-> s4-0 transform-index) 0)
      (set-vector! (-> s4-0 local-sphere) 0.0 0.0 0.0 1720.3201)
      (set-root-prim! s5-0 s4-0))
    (set! (-> s5-0 nav-radius) (* 0.75 (-> s5-0 root-prim local-sphere w)))
    (backup-collide-with-as s5-0)
    (set! (-> s5-0 event-self) 'touched)
    (set! (-> s5-0 max-iteration-count) (the-as uint 1))
    (set! (-> self root) s5-0))
  (set! (-> self root dynam gravity y) 50000.0)
  (set! (-> self root trans quad) (-> arg0 pos quad))
  (set-vector! (-> self root scale) 0.0 0.0 0.0 1.0)
  (quaternion-axis-angle! (-> self root quat) 0.0 1.0 0.0 (-> arg0 rotate))
  (initialize-skeleton self *smg-grenade-sg* '())
  (set! (-> self root transv quad) (-> arg0 vel quad))
  (set! (-> self blast-radius) (-> arg0 blast-radius))
  (set! (-> self water-height) (res-lump-float (-> self entity) 'water-height :default -4096000.0))
  (set! (-> self part2) (create-launch-control (-> *part-group-id-table* 710) self))
  (go smg-grenade-idle)
  (none))

(defun spawn-smg-grenade ((arg0 process-tree) (arg1 vector) (arg2 vector) (arg3 float) (arg6 float) (arg7 entity))
  (let ((s5-0 (new 'stack-no-clear 'smg-grenade-init-data)))
    (set! (-> s5-0 pos) arg1)
    (set! (-> s5-0 vel) arg2)
    (set! (-> s5-0 rotate) arg3)
    (set! (-> s5-0 blast-radius) arg6)
    (format 0 "HERE! ~%")
    (process-spawn smg-grenade s5-0 arg7 :to arg0))
  0
  (none))
